    <!DOCTYPE html>
    <html lang="en">

    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Admin Panel - Sahyapravashi</title>
        <link rel="stylesheet" href="css/admin.css" />
    </head>

    <body>

        <!-- Custom Modal for Alerts and Confirms -->
        <div id="customModal" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <p id="modalText"></p>
                <div class="modal-actions">
                    <button id="modalConfirmBtn" class="btn-confirm">Confirm</button>
                    <button id="modalCancelBtn" class="btn-cancel">Cancel</button>
                    <button id="modalOkBtn" class="btn-ok">OK</button>
                </div>
            </div>
        </div>


        <h1>Sahyapravashi â€” Admin Panel</h1>

        <nav>
            <button onclick="showSection('fortsSec', this)" class="active">Forts</button>
            <button onclick="showSection('packagesSec', this)">Packages</button>
            <button onclick="showSection('bookingsSec', this)">Bookings</button>
        </nav>

        <!-- FORTS SECTION -->
        <section id="fortsSec" class="section">
            <h2>Forts</h2>

            <div class="card">
                <h3>Add New Fort</h3>
                <form id="addFortForm" enctype="multipart/form-data">
                    <input name="name" placeholder="Fort Name" required />
                    <textarea name="description" placeholder="Description" rows="4"></textarea>
                    <input name="location" placeholder="Location" />
                    <input name="difficulty" placeholder="Difficulty" />
                    <input type="file" name="image" accept="image/*" />
                    <button type="submit">Add Fort</button>
                </form>
            </div>

            <div class="card" id="editFortCard" style="display:none;">
                <h3>Edit Fort</h3>
                <form id="editFortForm" enctype="multipart/form-data">
                    <input type="hidden" name="id" />
                    <input name="name" placeholder="Fort Name" required />
                    <textarea name="description" placeholder="Description" rows="4"></textarea>
                    <input name="location" placeholder="Location" />
                    <input name="difficulty" placeholder="Difficulty" />
                    <div>Existing Image: <img id="editFortImagePreview" src="" alt="No Image" /></div>
                    <input type="file" name="image" accept="image/*" />
                    <button type="submit">Update Fort</button>
                    <button type="button" onclick="hideEditFort()" class="btn-cancel">Cancel</button>
                </form>
            </div>

            <h3>Existing Forts</h3>
            <table id="fortsTable">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Location</th>
                        <th>Difficulty</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- PACKAGES SECTION -->
        <section id="packagesSec" class="section" style="display:none;">
            <h2>Packages</h2>

            <div class="card">
                <h3>Add Package</h3>
                <form id="addPackageForm" enctype="multipart/form-data">
                    <input name="name" placeholder="Package Name" required />
                    <input name="price" placeholder="Price" />
                    <textarea name="itinerary" placeholder="Itinerary (text)" rows="4"></textarea>
                    <input name="season" placeholder="Season" />
                    <input name="base_village" placeholder="Base Village" />
                    <input name="difficulty" placeholder="Difficulty" />
                    <input type="file" name="image" accept="image/*" />
                    <button type="submit">Add Package</button>
                </form>
            </div>

            <div class="card" id="editPackageCard" style="display:none;">
                <h3>Edit Package</h3>
                <form id="editPackageForm" enctype="multipart/form-data">
                    <input type="hidden" name="id" />
                    <input name="name" placeholder="Package Name" required />
                    <input name="price" placeholder="Price" />
                    <textarea name="itinerary" placeholder="Itinerary" rows="4"></textarea>
                    <input name="season" placeholder="Season" />
                    <input name="base_village" placeholder="Base Village" />
                    <input name="difficulty" placeholder="Difficulty" />
                    <div>Existing Image: <img id="editPackageImagePreview" src="" alt="No Image" /></div>
                    <input type="file" name="image" accept="image/*" />
                    <button type="submit">Update Package</button>
                    <button type="button" onclick="hideEditPackage()" class="btn-cancel">Cancel</button>
                </form>
            </div>

            <div class="card">
                <h3>Upload Multiple Images for Package</h3>
                <form id="uploadPackageImagesForm" enctype="multipart/form-data">
                    <select id="packageSelectForImages" required></select>
                    <input type="file" name="images" multiple accept="image/*" required/>
                    <button type="submit">Upload Images</button>
                </form>
            </div>

            <h3>Existing Packages</h3>
            <table id="packagesTable">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Season</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- BOOKINGS SECTION -->
        <section id="bookingsSec" class="section" style="display:none;">
            <h2>Bookings</h2>
            <table id="bookingsTable">
                <thead>
                    <tr>
                        <th>Package</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Participants</th>
                        <th>Message</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- <script>
            /* ======= Custom Modal Logic ======= */
            const customModal = document.getElementById('customModal');
            const modalText = document.getElementById('modalText');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            const modalOkBtn = document.getElementById('modalOkBtn');
            let confirmCallback = null;

            // Shows a confirmation dialog
            function showConfirm(text, callback) {
                modalText.textContent = text;
                confirmCallback = callback;
                modalConfirmBtn.style.display = 'inline-block';
                modalCancelBtn.style.display = 'inline-block';
                modalOkBtn.style.display = 'none';
                customModal.style.display = 'flex';
            }

            // Shows a simple notification alert
            function showAlert(text) {
                modalText.textContent = text;
                modalConfirmBtn.style.display = 'none';
                modalCancelBtn.style.display = 'none';
                modalOkBtn.style.display = 'inline-block';
                customModal.style.display = 'flex';
            }

            modalConfirmBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                customModal.style.display = 'none';
            });

            modalCancelBtn.addEventListener('click', () => {
                customModal.style.display = 'none';
            });
            
            modalOkBtn.addEventListener('click', () => {
                customModal.style.display = 'none';
            });


            /* ======= Helpers & UI ======= */
            function showSection(id, element) {
                document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
                document.getElementById(id).style.display = 'block';

                document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
                element.classList.add('active');
            }

            /* ======= FORTS ======= */
            async function loadForts() {
                try {
                    const res = await fetch('/api/forts');
                    if (!res.ok) throw new Error('Failed to fetch forts');
                    const forts = await res.json();
                    const tbody = document.querySelector('#fortsTable tbody');
                    tbody.innerHTML = '';
                    forts.forEach(f => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                        <td>${f.image_url ? `<img src="${f.image_url}" alt="${escapeHtml(f.name)}" />` : 'No Image'}</td>
                        <td>${escapeHtml(f.name)}</td>
                        <td>${escapeHtml(f.location || '')}</td>
                        <td>${escapeHtml(f.difficulty || '')}</td>
                        <td>
                            <button onclick="showEditFort(${f.id})">Edit</button>
                            <button onclick="deleteFort(${f.id})" class="btn-delete">Delete</button>
                        </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } catch (error) {
                    showAlert('Error: ' + error.message);
                }
            }

            document.getElementById('addFortForm').addEventListener('submit', async e => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const res = await fetch('/api/forts', { method: 'POST', body: fd });
                if (res.ok) { showAlert('Fort added successfully'); e.target.reset(); loadForts(); } else { showAlert('Error adding fort'); }
            });

            async function showEditFort(id) {
                const res = await fetch('/api/forts/' + id);
                if (!res.ok) { showAlert('Fort not found'); return; }
                const f = await res.json();
                const card = document.getElementById('editFortCard');
                const form = document.getElementById('editFortForm');
                card.style.display = 'block';
                form.id.value = f.id;
                form.name.value = f.name;
                form.description.value = f.description || '';
                form.location.value = f.location || '';
                form.difficulty.value = f.difficulty || '';
                document.getElementById('editFortImagePreview').src = f.image_url || '';
                form.existing_image_url = f.image_url || '';
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            function hideEditFort() {
                document.getElementById('editFortCard').style.display = 'none';
                document.getElementById('editFortForm').reset();
            }

            document.getElementById('editFortForm').addEventListener('submit', async e => {
                e.preventDefault();
                const form = e.target;
                const id = form.id.value;
                const fd = new FormData(form);
                if (!fd.get('image') || fd.get('image').size === 0) fd.append('existing_image_url', form.existing_image_url || '');
                const res = await fetch('/api/forts/' + id, { method: 'PUT', body: fd });
                if (res.ok) { showAlert('Fort updated successfully'); hideEditFort(); loadForts(); } else { showAlert('Error updating fort'); }
            });

            function deleteFort(id) {
                showConfirm('Are you sure you want to delete this fort?', async () => {
                    const res = await fetch('/api/forts/' + id, { method: 'DELETE' });
                    if (res.ok) { showAlert('Fort deleted'); loadForts(); } else { showAlert('Error deleting fort'); }
                });
            }

            /* ======= PACKAGES ======= */
            async function loadPackages() {
                const res = await fetch('/api/packages');
                const packs = await res.json();
                const tbody = document.querySelector('#packagesTable tbody');
                tbody.innerHTML = '';
                const select = document.getElementById('packageSelectForImages');
                select.innerHTML = '<option value="">-- Select a Package --</option>';
                packs.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${p.image_url ? `<img src="${p.image_url}" alt="${escapeHtml(p.name)}" />` : 'No Image'}</td>
                    <td>${escapeHtml(p.name)}</td>
                    <td>${escapeHtml(p.price || '')}</td>
                    <td>${escapeHtml(p.season || '')}</td>
                    <td>
                        <button onclick="showEditPackage(${p.id})">Edit</button>
                        <button onclick="deletePackage(${p.id})" class="btn-delete">Delete</button>
                    </td>
                    `;
                    tbody.appendChild(tr);

                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    select.appendChild(option);
                });
            }

            document.getElementById('addPackageForm').addEventListener('submit', async e => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const res = await fetch('/api/packages', { method: 'POST', body: fd });
                if (res.ok) { showAlert('Package added successfully'); e.target.reset(); loadPackages(); } else { showAlert('Error adding package'); }
            });
            
            async function showEditPackage(id) {
                const res = await fetch('/api/packages/' + id);
                if (!res.ok) { showAlert('Package not found'); return; }
                const p = await res.json();
                const card = document.getElementById('editPackageCard');
                const form = document.getElementById('editPackageForm');
                card.style.display = 'block';
                form.id.value = p.id;
                form.name.value = p.name;
                form.price.value = p.price || '';
                form.itinerary.value = p.itinerary || '';
                form.season.value = p.season || '';
                form.base_village.value = p.base_village || '';
                form.difficulty.value = p.difficulty || '';
                document.getElementById('editPackageImagePreview').src = p.image_url || '';
                form.existing_image_url = p.image_url || '';
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            function hideEditPackage() {
                document.getElementById('editPackageCard').style.display = 'none';
                document.getElementById('editPackageForm').reset();
            }

            document.getElementById('editPackageForm').addEventListener('submit', async e => {
                e.preventDefault();
                const form = e.target;
                const id = form.id.value;
                const fd = new FormData(form);
                if (!fd.get('image') || fd.get('image').size === 0) fd.append('existing_image_url', form.existing_image_url || '');
                const res = await fetch('/api/packages/' + id, { method: 'PUT', body: fd });
                if (res.ok) { showAlert('Package updated successfully'); hideEditPackage(); loadPackages(); } else { showAlert('Error updating package'); }
            });

            function deletePackage(id) {
                showConfirm('Delete package? This removes the package and all its images.', async () => {
                    const res = await fetch('/api/packages/' + id, { method: 'DELETE' });
                    if (res.ok) { showAlert('Package deleted'); loadPackages(); } else { showAlert('Error deleting package'); }
                });
            }

            document.getElementById('uploadPackageImagesForm').addEventListener('submit', async e => {
                e.preventDefault();
                const form = e.target;
                const packageId = document.getElementById('packageSelectForImages').value;
                if (!packageId) return showAlert('Please select a package first.');
                const files = form.querySelector('input[name="images"]').files;
                if (!files.length) return showAlert('Please choose image files to upload.');
                
                const fd = new FormData();
                for (const f of files) fd.append('images', f);
                
                const res = await fetch('/api/packages/' + packageId + '/images', { method: 'POST', body: fd });
                if (res.ok) { showAlert('Images uploaded successfully'); form.reset(); } else { showAlert('Error uploading images'); }
            });

            /* ======= BOOKINGS ======= */
            async function loadBookings() {
                const res = await fetch('/api/bookings');
                const bookings = await res.json();
                const tbody = document.querySelector('#bookingsTable tbody');
                tbody.innerHTML = '';
                bookings.forEach(b => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${escapeHtml(b.package_name || '')}</td>
                    <td>${escapeHtml(b.fullname || '')}</td>
                    <td>${escapeHtml(b.email || '')}</td>
                    <td>${escapeHtml(b.phone || '')}</td>
                    <td>${escapeHtml(String(b.participants || ''))}</td>
                    <td>${escapeHtml(b.message || '')}</td>
                    <td><span class="status status-${(b.status || 'pending').toLowerCase()}">${escapeHtml(b.status || 'Pending')}</span></td>
                    <td>
                        <button onclick="updateBookingStatus(${b.id}, 'Approved')" class="btn-approve">Approve</button>
                        <button onclick="updateBookingStatus(${b.id}, 'Rejected')" class="btn-reject">Reject</button>
                        <button onclick="deleteBooking(${b.id})" class="btn-delete">Delete</button>
                    </td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            async function updateBookingStatus(id, status) {
                const res = await fetch('/api/bookings/' + id + '/status', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                if (res.ok) { showAlert('Booking status updated to ' + status); loadBookings(); } else { showAlert('Error updating status'); }
            }

            function deleteBooking(id) {
                showConfirm('Are you sure you want to delete this booking?', async () => {
                    const res = await fetch('/api/bookings/' + id, { method: 'DELETE' });
                    if (res.ok) { showAlert('Booking deleted'); loadBookings(); } else { showAlert('Error deleting booking'); }
                });
            }

            /* ======= Utility & Init ======= */
            function escapeHtml(s) {
                return String(s || '').replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
            }

            async function init() {
                // Set default section on page load
                document.querySelector('nav button.active').click();
                await loadForts();
                await loadPackages();
                await loadBookings();
            }
            init();     
        </script> -->
        <script src="./javascript/admin.js"></script>
    </body>

    </html>
